{% extends "base.html" %}

{% block title %}Products - Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-4 animate-fade-in">
            <i class="bi bi-box-seam"></i> Products Dashboard
        </h1>
    </div>
</div>

<!-- Filters Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card animate-slide-up">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form id="productFilterForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Min Price</label>
                            <input type="number" class="form-control filter-input" name="price_min" 
                                   placeholder="Min ₹" value="{{ active_filters.get('price_min', '') }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Price</label>
                            <input type="number" class="form-control filter-input" name="price_max" 
                                   placeholder="Max ₹" value="{{ active_filters.get('price_max', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Min Rating</label>
                            <select class="form-select filter-input" name="rating_min">
                                <option value="">All</option>
                                <option value="1" {% if active_filters.get('rating_min') == '1' %}selected{% endif %}>1+</option>
                                <option value="2" {% if active_filters.get('rating_min') == '2' %}selected{% endif %}>2+</option>
                                <option value="3" {% if active_filters.get('rating_min') == '3' %}selected{% endif %}>3+</option>
                                <option value="4" {% if active_filters.get('rating_min') == '4' %}selected{% endif %}>4+</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Category</label>
                            <select class="form-select filter-input" name="category">
                                <option value="">All</option>
                                {% for cat in filter_options.categories %}
                                <option value="{{ cat }}" {% if active_filters.get('category') == cat %}selected{% endif %}>
                                    {{ cat }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control filter-input" name="search" 
                                   placeholder="Search..." value="{{ active_filters.get('search', '') }}">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" id="applyFilters">
                                <i class="bi bi-check-circle"></i> Apply Filters
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetFilters">
                                <i class="bi bi-x-circle"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card chart-card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Category Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="productCategoryChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card chart-card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Review Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="productReviewChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card chart-card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-scatter"></i> Price vs Rating</h6>
            </div>
            <div class="card-body">
                <canvas id="productScatterChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Results Info -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            Showing <strong id="productCount">{{ products|length }}</strong> products
        </div>
    </div>
</div>

<!-- Products Grid -->
<div class="row g-4" id="productsGrid">
    {% for product in products %}
    <div class="col-md-6 col-lg-4 col-xl-3 product-item">
        <div class="card product-card-detailed h-100 animate-fade-in">
            <a href="{{ url_for('dashboard.product_detail', product_id=product['Product Identifier']) }}">
                <img src="{{ product.Image }}" class="card-img-top product-image-large" alt="{{ product.Title }}">
            </a>
            <div class="card-body">
                <a href="{{ url_for('dashboard.product_detail', product_id=product['Product Identifier']) }}" class="text-decoration-none text-dark">
                    <h6 class="card-title" title="{{ product.Title }}">{{ product.Title[:60] }}...</h6>
                </a>
                <div class="mb-2">
                    <span class="badge bg-success fs-6">₹{{ "%.0f"|format(product.Price) }}</span>
                    <span class="badge bg-warning text-dark ms-2">
                        <i class="bi bi-star-fill"></i> {{ "%.1f"|format(product.Ratings) }}
                    </span>
                </div>
                <p class="card-text small text-muted mb-2">
                    <i class="bi bi-chat-left-text"></i> {{ product.Review }} reviews
                </p>
                {% if product['Monthly Sales'] %}
                <p class="card-text small text-success mb-2">
                    <i class="bi bi-graph-up"></i> {{ product['Monthly Sales'] }}
                </p>
                {% endif %}
                <div class="d-grid gap-2">
                    <a href="{{ url_for('dashboard.product_detail', product_id=product['Product Identifier']) }}" 
                       class="btn btn-sm btn-primary">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                    <button class="btn btn-sm btn-outline-secondary add-to-comparison" 
                            data-product-id="{{ product['Product Identifier'] }}"
                            data-product-title="{{ product.Title }}"
                            data-product-price="{{ product.Price }}"
                            data-product-image="{{ product.Image }}"
                            data-product-rating="{{ product.Ratings }}">
                        <i class="bi bi-plus-circle"></i> Compare
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Suppliers Modal -->
<div class="modal fade" id="suppliersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Suppliers for <span id="modalProductName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="suppliersModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/filters.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    let productCharts = {};
    
    // Load product charts
    function loadProductCharts() {
        const formData = new FormData(document.getElementById('productFilterForm'));
        const params = new URLSearchParams(formData);
        
        fetch(`/api/charts/products?${params}`)
            .then(response => response.json())
            .then(data => {
                // Update count
                document.getElementById('productCount').textContent = data.count;
                
                // Category chart
                if (productCharts.category) productCharts.category.destroy();
                productCharts.category = createPieChart('productCategoryChart', 
                    data.category.labels, data.category.values, 'Categories');
                
                // Review chart
                if (productCharts.review) productCharts.review.destroy();
                productCharts.review = createBarChart('productReviewChart', 
                    data.reviews.labels, data.reviews.values, 'Reviews', '#36a2eb');
                
                // Scatter chart
                if (productCharts.scatter) productCharts.scatter.destroy();
                productCharts.scatter = createScatterChart('productScatterChart',
                    data.scatter.prices, data.scatter.ratings, data.scatter.labels);
            });
    }
    
    // Apply filters
    document.getElementById('applyFilters').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('productFilterForm'));
        const params = new URLSearchParams(formData);
        window.location.href = `/products?${params}`;
    });
    
    // Reset filters
    document.getElementById('resetFilters').addEventListener('click', function() {
        window.location.href = '/products';
    });
    
    // View suppliers
    document.querySelectorAll('.view-suppliers').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.product;
            document.getElementById('modalProductName').textContent = productId;
            
            fetch(`/api/product-vs-suppliers/${encodeURIComponent(productId)}`)
                .then(response => response.json())
                .then(data => {
                    let html = `
                        <div class="alert alert-info">
                            <h6>Price Comparison</h6>
                            <p>Product Price: ₹${data.price_comparison.product_price.toFixed(0)} | 
                               Avg Supplier: ₹${data.price_comparison.avg_supplier_price.toFixed(0)} | 
                               Potential Savings: ${data.price_comparison.potential_savings.toFixed(1)}%</p>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Supplier</th>
                                    <th>Location</th>
                                    <th>Price</th>
                                    <th>Rating</th>
                                    <th>Reviews</th>
                                    <th>Contact</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.suppliers.forEach(s => {
                        html += `
                            <tr>
                                <td>${s['Supplier Round']}</td>
                                <td>${s['Supplier Name']}</td>
                                <td>${s.Location}</td>
                                <td>₹${s.Price.toFixed(0)}</td>
                                <td><span class="badge bg-warning text-dark">${s.Rating.toFixed(1)} ⭐</span></td>
                                <td>${s.Reviews}</td>
                                <td><small>${s['Contact Phone']}</small></td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('suppliersModalBody').innerHTML = html;
                });
            
            new bootstrap.Modal(document.getElementById('suppliersModal')).show();
        });
    });
    
    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        loadProductCharts();
    });
</script>
{% endblock %}