{% extends "base.html" %}

{% block title %}Comparisons - Dashboard{% endblock %}

{% block extra_css %}
<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-4 animate-fade-in">
            <i class="bi bi-bar-chart"></i> Comparison Dashboard
        </h1>
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist" type="button"
            role="tab">
            <i class="bi bi-heart-fill"></i> Wishlist
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button"
            role="tab">
            <i class="bi bi-box-seam"></i> Products
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="suppliers-tab" data-bs-toggle="tab" data-bs-target="#suppliers" type="button"
            role="tab">
            <i class="bi bi-building"></i> Suppliers
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Wishlist Tab -->
    <div class="tab-pane fade show active" id="wishlist" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card animate-slide-up">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-heart-fill"></i> My Wishlist</h5>
                    </div>
                    <div class="card-body">
                        <div id="wishlistItems">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Your wishlist is empty. Add products from the Products
                                page to start comparing!
                            </div>
                        </div>
                        <button class="btn btn-danger mt-3" id="compareWishlist" style="display: none;">
                            <i class="bi bi-arrows-angle-contract"></i> Compare Wishlist Items
                        </button>
                    </div>
                </div>

                <div class="card mt-4" id="wishlistComparisonResult" style="display: none;">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Wishlist Comparison Results</h6>
                    </div>
                    <div class="card-body" id="wishlistComparisonBody"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Tab -->
    <div class="tab-pane fade" id="products" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card animate-slide-up">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Compare Products</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Select Products (up to 4)</label>
                            <select class="form-select select2-products" id="productSelect" multiple>
                                {% for product in product_list %}
                                <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Type to search products</small>
                        </div>
                        <button class="btn btn-primary" id="compareProducts">
                            <i class="bi bi-arrows-angle-contract"></i> Compare Products
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card mt-4 mt-lg-0" id="productComparisonResult" style="display: none;">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Product Comparison Results</h6>
                    </div>
                    <div class="card-body" id="productComparisonBody"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Suppliers Tab -->
    <div class="tab-pane fade" id="suppliers" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card animate-slide-up">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Compare Suppliers</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Select Suppliers (up to 4)</label>
                            <select class="form-select select2-suppliers" id="supplierSelect" multiple>
                                {% for supplier in supplier_list %}
                                <option value="{{ supplier }}">{{ supplier }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Type to search suppliers</small>
                        </div>
                        <button class="btn btn-success" id="compareSuppliers">
                            <i class="bi bi-arrows-angle-contract"></i> Compare Suppliers
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card mt-4 mt-lg-0" id="supplierComparisonResult" style="display: none;">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Supplier Comparison Results</h6>
                    </div>
                    <div class="card-body" id="supplierComparisonBody"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card" id="comparisonChartCard" style="display: none;">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Visual Comparison</h5>
            </div>
            <div class="card-body">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS for searchable dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    let comparisonChart = null;

    // Initialize Select2 for searchable dropdowns
    $(document).ready(function () {
        $('.select2-products').select2({
            theme: 'bootstrap-5',
            placeholder: 'Search and select products...',
            allowClear: true,
            maximumSelectionLength: 4
        });

        $('.select2-suppliers').select2({
            theme: 'bootstrap-5',
            placeholder: 'Search and select suppliers...',
            allowClear: true,
            maximumSelectionLength: 4
        });
    });

    // Load wishlist from database
    function loadWishlist() {
        fetch('/api/wishlist')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('wishlistItems');
                const compareBtn = document.getElementById('compareWishlist');

                if (data.items.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Your wishlist is empty. Add products from the Products page to start comparing!</div>';
                    compareBtn.style.display = 'none';
                } else {
                    let html = '<div class="row g-3">';
                    data.items.forEach(item => {
                        html += `
                            <div class="col-md-4">
                                <div class="card h-100 wishlist-card">
                                    <img src="${item.product_image || 'https://via.placeholder.com/150'}" class="card-img-top" alt="${item.product_title}" style="height: 200px; object-fit: cover;">
                                    <div class="card-body">
                                        <h6 class="card-title">${item.product_title.substring(0, 50)}...</h6>
                                        <p class="text-primary fw-bold mb-1">‚Çπ${parseFloat(item.product_price || 0).toFixed(0)}</p>
                                        <p class="text-warning mb-2">‚≠ê ${parseFloat(item.product_rating || 0).toFixed(1)}</p>
                                        <button class="btn btn-sm btn-danger w-100" onclick="removeFromWishlist(${item.id})">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                    compareBtn.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading wishlist:', error);
                document.getElementById('wishlistItems').innerHTML =
                    '<div class="alert alert-danger"><i class="bi bi-exclamation-circle"></i> Error loading wishlist. Please try again.</div>';
            });
    }

    function removeFromWishlist(itemId) {
        if (!confirm('Remove this item from wishlist?')) return;

        fetch(`/api/wishlist/remove/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                loadWishlist();
                showNotification('Item removed from wishlist', 'success');
            })
            .catch(error => {
                console.error('Error removing from wishlist:', error);
                showNotification('Error removing item', 'error');
            });
    }

    function showNotification(message, type) {
        // Simple notification (you can enhance this)
        alert(message);
    }

    // Compare wishlist items
    document.getElementById('compareWishlist').addEventListener('click', function () {
        fetch('/api/wishlist')
            .then(response => response.json())
            .then(wishlistData => {
                if (wishlistData.items.length < 2) {
                    alert('Please add at least 2 items to your wishlist to compare');
                    return;
                }

                const params = new URLSearchParams();
                wishlistData.items.forEach(item => params.append('ids[]', item.product_identifier));

                fetch(`/api/compare-products?${params}`)
                    .then(response => response.json())
                    .then(data => {
                        let html = '<div class="table-responsive"><table class="table table-bordered">';
                        html += '<thead><tr><th>Metric</th>';
                        data.forEach(p => html += `<th>${p['Product Identifier']}</th>`);
                        html += '</tr></thead><tbody>';

                        html += '<tr><td><strong>Price</strong></td>';
                        data.forEach(p => html += `<td>‚Çπ${p.Price.toFixed(0)} ${p.is_cheapest ? 'üèÜ' : ''}</td>`);
                        html += '</tr>';

                        html += '<tr><td><strong>Rating</strong></td>';
                        data.forEach(p => html += `<td>${p.Ratings.toFixed(1)} ‚≠ê ${p.is_highest_rated ? 'üèÜ' : ''}</td>`);
                        html += '</tr>';

                        html += '<tr><td><strong>Reviews</strong></td>';
                        data.forEach(p => html += `<td>${p.Review} ${p.is_most_reviewed ? 'üèÜ' : ''}</td>`);
                        html += '</tr>';

                        html += '</tbody></table></div>';
                        document.getElementById('wishlistComparisonBody').innerHTML = html;
                        document.getElementById('wishlistComparisonResult').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error comparing wishlist:', error);
                        alert('Error comparing wishlist items');
                    });
            });
    });

    // Load wishlist on page load
    document.addEventListener('DOMContentLoaded', loadWishlist);

    document.getElementById('compareProducts').addEventListener('click', function () {
        const selected = $('.select2-products').val().slice(0, 4);

        if (selected.length < 2) {
            alert('Please select at least 2 products');
            return;
        }

        const params = new URLSearchParams();
        selected.forEach(id => params.append('ids[]', id));

        fetch(`/api/compare-products?${params}`)
            .then(response => response.json())
            .then(data => {
                let html = '<div class="table-responsive"><table class="table table-bordered">';
                html += '<thead><tr><th>Metric</th>';
                data.forEach(p => html += `<th>${p['Product Identifier']}</th>`);
                html += '</tr></thead><tbody>';

                html += '<tr><td><strong>Price</strong></td>';
                data.forEach(p => html += `<td>‚Çπ${p.Price.toFixed(0)} ${p.is_cheapest ? 'üèÜ' : ''}</td>`);
                html += '</tr>';

                html += '<tr><td><strong>Rating</strong></td>';
                data.forEach(p => html += `<td>${p.Ratings.toFixed(1)} ‚≠ê ${p.is_highest_rated ? 'üèÜ' : ''}</td>`);
                html += '</tr>';

                html += '<tr><td><strong>Reviews</strong></td>';
                data.forEach(p => html += `<td>${p.Review} ${p.is_most_reviewed ? 'üèÜ' : ''}</td>`);
                html += '</tr>';

                html += '</tbody></table></div>';
                document.getElementById('productComparisonBody').innerHTML = html;
                document.getElementById('productComparisonResult').style.display = 'block';

                // Chart
                const labels = data.map(p => p['Product Identifier'].slice(0, 20));
                const prices = data.map(p => p.Price);
                const ratings = data.map(p => p.Ratings * 100);

                if (comparisonChart) comparisonChart.destroy();
                const ctx = document.getElementById('comparisonChart');
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Price (‚Çπ)',
                                data: prices,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)'
                            },
                            {
                                label: 'Rating (√ó100)',
                                data: ratings,
                                backgroundColor: 'rgba(255, 206, 86, 0.6)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                document.getElementById('comparisonChartCard').style.display = 'block';
            });
    });

    document.getElementById('compareSuppliers').addEventListener('click', function () {
        const selected = $('.select2-suppliers').val().slice(0, 4);

        if (selected.length < 2) {
            alert('Please select at least 2 suppliers');
            return;
        }

        const params = new URLSearchParams();
        selected.forEach(name => params.append('names[]', name));

        fetch(`/api/compare-suppliers?${params}`)
            .then(response => response.json())
            .then(data => {
                let html = '<div class="table-responsive"><table class="table table-bordered">';
                html += '<thead><tr><th>Metric</th>';
                data.forEach(s => html += `<th>${s.name}</th>`);
                html += '</tr></thead><tbody>';

                html += '<tr><td><strong>Rating</strong></td>';
                data.forEach(s => html += `<td>${s.avg_rating.toFixed(1)} ‚≠ê ${s.is_highest_rated ? 'üèÜ' : ''}</td>`);
                html += '</tr>';

                html += '<tr><td><strong>Total Reviews</strong></td>';
                data.forEach(s => html += `<td>${s.total_reviews} ${s.is_most_reviewed ? 'üèÜ' : ''}</td>`);
                html += '</tr>';

                html += '<tr><td><strong>Location</strong></td>';
                data.forEach(s => html += `<td>${s.location}</td>`);
                html += '</tr>';

                html += '</tbody></table></div>';
                document.getElementById('supplierComparisonBody').innerHTML = html;
                document.getElementById('supplierComparisonResult').style.display = 'block';
            });
    });
</script>
{% endblock %}